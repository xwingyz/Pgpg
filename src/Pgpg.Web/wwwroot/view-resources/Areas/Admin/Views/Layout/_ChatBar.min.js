(function(n){n(function(){var u=abp.services.app.chat,r=abp.services.app.friendship,i={load:function(n){abp.services.app.session.getCurrentLoginInformations({async:!1}).done(function(t){i.user=t.user;i.tenant=t.tenant;n()})}},t={friends:[],tenantToTenantChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToTenant"),tenantToHostChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToHost"),serverClientTimeDifference:0,selectedUser:null,isOpen:!1,getFriendOrNull:function(n,i){var r=_.where(t.friends,{friendUserId:parseInt(n),friendTenantId:i?parseInt(i):null});return r.length?r[0]:null},getFixedMessageTime:function(n){return moment(n).add(-1*t.serverClientTimeDifference,"seconds").format("YYYY-MM-DDTHH:mm:ssZ")},getFriendsAndSettings:function(n){u.getUserChatFriendsWithSettings().done(function(i){t.friends=i.friends;t.serverClientTimeDifference=app.calculateTimeDifference(abp.clock.now(),i.serverTime,"seconds");t.triggerUnreadMessageCountChangeEvent();t.renderFriendLists(t.friends);n()})},loadLastState:function(){app.localStorage.getItem("app.chat.isOpen",function(i){t.isOpen=i;t.adjustNotifyPosition();app.localStorage.getItem("app.chat.pinned",function(i){t.pinned=i;var r=n("a.page-quick-sidebar-pinner");r.find("i.icon-pin").attr("class","icon-pin "+(t.pinned?"pinned":"unpinned"))});t.isOpen&&n("body").addClass("page-quick-sidebar-open").promise().done(function(){app.localStorage.getItem("app.chat.selectedUser",function(i){i?(n(".page-quick-sidebar-chat").addClass("page-quick-sidebar-content-item-shown"),t.selectFriend(i.friendUserId,i.friendTenantId)):n(".page-quick-sidebar-chat").removeClass("page-quick-sidebar-content-item-shown")})})})},changeChatPanelIsOpenOnLocalStorage:function(){app.localStorage.setItem("app.chat.isOpen",t.isOpen)},changeChatUserOnLocalStorage:function(){app.localStorage.setItem("app.chat.selectedUser",t.selectedUser)},changeChatPanelPinnedOnLocalStorage:function(){app.localStorage.setItem("app.chat.pinned",t.pinned)},changeChatPanelPinned:function(i){t.pinned=i;var r=n(".page-quick-sidebar-pinner");r.find("i.icon-pin").attr("class","icon-pin "+(t.pinned?"pinned":"unpinned"));t.changeChatPanelPinnedOnLocalStorage()},selectFriend:function(i,r){var u=t.getFriendOrNull(i,r),f,e;t.selectedUser=u;t.changeChatUserOnLocalStorage();t.user.setSelectedUserOnlineStatus(u.isOnline);t.selectedUser.friendProfilePictureId?(f=t.selectedUser.friendTenantId?t.selectedUser.friendTenantId:"",n("#selectedChatUserImage").attr("src",abp.appPath+"Profile/GetFriendProfilePictureById?id="+t.selectedUser.friendProfilePictureId+"&userId="+t.selectedUser.friendUserId+"&tenantId="+f)):n("#selectedChatUserImage").attr("src",abp.appPath+"Common/Images/default-profile-picture.png");n("#selectedChatUserName").text(t.user.getShownUserName(t.selectedUser.friendTenancyName,t.selectedUser.friendUserName));n("#ChatMessage").val("");t.selectedUser.state!==app.consts.friendshipState.blocked?(n("#liBanChatUser, #ChatMessageWrapper").show(),n("#liUnbanChatUser, #UnblockUserButton").hide(),n("#ChatMessage").removeAttr("disabled"),n("#ChatMessage").focus(),n("#SendChatMessageButton").removeAttr("disabled")):(n("#liBanChatUser, #ChatMessageWrapper").hide(),n("#liUnbanChatUser, #UnblockUserButton").show(),n("#ChatMessage").attr("disabled","disabled"),n("#SendChatMessageButton").attr("disabled","disabled"));u.messagesLoaded?(e=t.renderMessages(u.messages),n("#UserChatMessages").html(e),t.scrollToBottom(),n(".timeago").timeago(),t.user.markAllUnreadMessagesOfUserAsRead(t.selectedUser)):t.user.loadMessages(u,function(){u.messagesLoaded=!0;t.scrollToBottom()})},changeFriendState:function(n,i){var r=t.getFriendOrNull(n.friendUserId,n.friendTenantId);r&&(r.state=i,t.renderFriendLists(t.friends))},getFormattedFriends:function(i){return n.each(i,function(n,i){i.profilePicturePath=t.getFriendProfilePicturePath(i);i.shownUserName=t.user.getShownUserName(i.friendTenancyName,i.friendUserName)}),i},renderFriendList:function(t,i){var r=n("#UserFriendTemplate").html(),u;Mustache.parse(r);u=Mustache.render(r,t);i.html(u)},renderFriendLists:function(i){var r,u;i=t.getFormattedFriends(i);r=_.where(i,{state:app.consts.friendshipState.accepted});t.renderFriendList(r,n("#friendListFriends"));u=_.where(i,{state:app.consts.friendshipState.blocked});t.renderFriendList(u,n("#friendListBlockeds"));r.length?n("#EmptyFriendListInfo").hide():n("#EmptyFriendListInfo").show();u.length?n("#EmptyBlockedFriendListInfo").hide():n("#EmptyBlockedFriendListInfo").show()},getFriendProfilePicturePath:function(n){if(!n.friendProfilePictureId)return abp.appPath+"Common/Images/default-profile-picture.png";var t=n.friendTenantId?n.friendTenantId:"";return abp.appPath+"Profile/GetFriendProfilePictureById?id="+n.friendProfilePictureId+"&userId="+n.friendUserId+"&tenantId="+t},sendMessage:function(){n("form[name='chatMessageForm']").valid()&&t.selectedUser.state!==app.consts.friendshipState.blocked&&(n("#SendChatMessageButton").attr("disabled","disabled"),app.chat.sendMessage({tenantId:t.selectedUser.friendTenantId,userId:t.selectedUser.friendUserId,message:n("#ChatMessage").val(),tenancyName:i.tenant?i.tenant.tenancyName:null,userName:i.user.userName,profilePictureId:i.user.profilePictureId},function(){n("#ChatMessage").val("");n("#SendChatMessageButton").removeAttr("disabled")}))},getFormattedMessages:function(r){return n.each(r,function(n,r){r.creationTime=t.getFixedMessageTime(r.creationTime);r.cssClass=r.side===app.chat.side.sender?"post out":"post in";r.shownUserName=r.side===app.chat.side.sender?i.user.userName:t.selectedUser.friendUserName;r.profilePicturePath=r.side===app.chat.side.sender?i.user.profilePictureId?abp.appPath+"Profile/GetProfilePictureById?id="+i.user.profilePictureId:abp.appPath+"Common/Images/default-profile-picture.png":t.getFriendProfilePicturePath(t.selectedUser)}),r},renderMessages:function(i){i=t.getFormattedMessages(i);var r=n("#UserChatMessageTemplate").html();return Mustache.parse(r),Mustache.render(r,i)},scrollToBottom:function(){var t=n(".page-quick-sidebar-chat-user-messages"),i=t.prop("scrollHeight")+"px";t.slimScroll({scrollTo:i})},adjustNotifyPosition:function(){t.isOpen?app.changeNotifyPosition("toast-chat-open"):app.changeNotifyPosition("toast-bottom-right")},triggerUnreadMessageCountChangeEvent:function(){var n=0;t&&t.friends&&(n=_.reduce(t.friends,function(n,t){return n+t.unreadMessageCount},0));abp.event.trigger("app.chat.unreadMessageCountChanged",n)},bindUiEvents:function(){QuickSidebar.init(function(n,i){i!==0||t.selectedUser.allPreviousMessagesLoaded||t.user.loadingPreviousUserMessages||t.user.loadMessages(t.selectedUser)});n(".page-quick-sidebar-back-to-list").on("click",function(){t.selectedUser=null;t.changeChatUserOnLocalStorage()});n(".dropdown-quick-sidebar-toggler a, .page-quick-sidebar-toggler, .quick-sidebar-toggler").on("click",function(){t.isOpen=n("body").hasClass("page-quick-sidebar-open");t.adjustNotifyPosition();t.changeChatPanelIsOpenOnLocalStorage();t.user.markAllUnreadMessagesOfUserAsRead(t.selectedUser)});n(".page-quick-sidebar-chat-users").on("click",".media-list > .media",function(){var i=n(this).attr("data-friend-user-id"),r=n(this).attr("data-friend-tenant-id");t.selectFriend(i,r)});n("#liBanChatUser a").click(function(){t.user.block(t.selectedUser)});n("#liUnbanChatUser, #UnblockUserButton").click(function(){t.user.unblock(t.selectedUser)});n("#SearchChatUserButton").click(function(){t.user.search()});n("#ChatUserSearchUserName, #ChatUserSearchTenancyName").keypress(function(n){n.which===13&&t.user.search()});n("#SendChatMessageButton").click(function(){t.sendMessage()});n("#ChatMessage").keypress(function(n){n.which===13&&(n.preventDefault(),t.sendMessage())});n("#ChatUserSearchUserName").on("keyup",function(){var i=n(this).val(),r;i?n("#SearchChatUserButton").removeClass("hidden"):n("#SearchChatUserButton").addClass("hidden");r=_.filter(t.friends,function(n){return t.user.getShownUserName(n.friendTenancyName,n.friendUserName).toLowerCase().indexOf(i.toLowerCase())>=0});t.renderFriendLists(r)});n("div.page-quick-sidebar-wrapper").on("mouseleave",function(){t.pinned||(n("body").removeClass("page-quick-sidebar-open"),t.isOpen=!1,t.adjustNotifyPosition(),t.changeChatPanelIsOpenOnLocalStorage())});n("form[name='chatMessageForm']").validate({invalidHandler:function(){n("#SendChatMessageButton").attr("disabled","disabled")},success:function(){n("#SendChatMessageButton").removeAttr("disabled")}});n(".page-quick-sidebar-pinner").click(function(){t.changeChatPanelPinned(!t.pinned)});!t.tenantToTenantChatAllowed&&t.tenantToHostChatAllowed&&n("#InterTenantChatHintIcon").hide()},registerEvents:function(){abp.event.on("app.chat.messageReceived",function(i){var r=t.getFriendOrNull(i.targetUserId,i.targetTenantId),u;r&&(r.messages=r.messages||[],r.messages.push(i),i.side===app.chat.side.receiver&&(r.unreadMessageCount+=1,i.readState=app.chat.readState.unread,t.user.changeUnreadMessageCount(r.friendTenantId,r.friendUserId,r.unreadMessageCount),t.triggerUnreadMessageCountChangeEvent(),t.isOpen&&t.selectedUser!==null&&r.friendTenantId===t.selectedUser.friendTenantId&&r.friendUserId===t.selectedUser.friendUserId?t.user.markAllUnreadMessagesOfUserAsRead(t.selectedUser):abp.notify.info(abp.utils.formatString("{0}: {1}",r.friendUserName,abp.utils.truncateString(i.message,100)),null,{onclick:function(){n("body").hasClass("page-quick-sidebar-open")||(n("body").addClass("page-quick-sidebar-open"),t.isOpen=!0,t.changeChatPanelIsOpenOnLocalStorage());n(".page-quick-sidebar-chat").hasClass("page-quick-sidebar-content-item-shown")||n(".page-quick-sidebar-chat").addClass("page-quick-sidebar-content-item-shown");t.selectFriend(r.friendUserId,r.friendTenantId);t.changeChatPanelPinned(!0)}})),t.selectedUser!==null&&r.friendUserId===t.selectedUser.friendUserId&&r.friendTenantId===t.selectedUser.friendTenantId&&(u=t.renderMessages([i]),n("#UserChatMessages").append(u),n(".timeago").timeago()),t.scrollToBottom())});abp.event.on("app.chat.friendshipRequestReceived",function(n,i){i||abp.notify.info(abp.utils.formatString(app.localize("UserSendYouAFriendshipRequest"),n.friendUserName));_.where(t.friends,{userId:n.friendUserId,tenantId:n.friendTenantId}).length||(t.friends.push(n),t.renderFriendLists(t.friends))});abp.event.on("app.chat.userConnectionStateChanged",function(n){t.user.setFriendOnlineStatus(n.friend.userId,n.friend.tenantId,n.isConnected)});abp.event.on("app.chat.userStateChanged",function(n){var i=t.getFriendOrNull(n.friend.userId,n.friend.tenantId);i&&(i.state=n.state,t.renderFriendLists(t.friends))});abp.event.on("app.chat.allUnreadMessagesOfUserRead",function(n){var i=t.getFriendOrNull(n.friend.userId,n.friend.tenantId);i&&(i.unreadMessageCount=0,t.user.changeUnreadMessageCount(i.friendTenantId,i.friendUserId,i.unreadMessageCount),t.triggerUnreadMessageCountChangeEvent())});abp.event.on("app.chat.connected",function(){t.getFriendsAndSettings(function(){t.bindUiEvents();t.loadLastState()})})},init:function(){t.registerEvents();i.load(function(){t.interTenantChatAllowed=abp.features.isEnabled("App.ChatFeature.TenantToTenant")||abp.features.isEnabled("App.ChatFeature.TenantToHost")||!i.tenant})},user:{loadingPreviousUserMessages:!1,userNameFilter:"",getShownUserName:function(n,t){return(n?n:".")+"\\"+t},block:function(i){r.blockUser({userId:i.friendUserId,tenantId:i.friendTenantId}).done(function(){t.changeFriendState(i,app.consts.friendshipState.blocked);abp.notify.info(app.localize("UserBlocked"));n("#ChatMessage").attr("disabled","disabled");n("#SendChatMessageButton").attr("disabled","disabled");n("#liBanChatUser, #ChatMessageWrapper").hide();n("#liUnbanChatUser, #UnblockUserButton").show()})},unblock:function(i){r.unblockUser({userId:i.friendUserId,tenantId:i.friendTenantId}).done(function(){t.changeFriendState(i,app.consts.friendshipState.accepted);abp.notify.info(app.localize("UserUnblocked"));n("#ChatMessage").removeAttr("disabled");n("#ChatMessage").focus();n("#SendChatMessageButton").removeAttr("disabled");n("#liBanChatUser, #ChatMessageWrapper").show();n("#liUnbanChatUser, #UnblockUserButton").hide()})},markAllUnreadMessagesOfUserAsRead:function(i){if(i&&t.isOpen){var f=_.where(i.messages,{readState:app.chat.readState.unread}),r=_.pluck(f,"id");r.length&&u.markAllUnreadMessagesOfUserAsRead({tenantId:i.friendTenantId,userId:i.friendUserId}).done(function(){n.each(i.messages,function(n,t){r.indexOf(t.id)>=0&&(t.readState=app.chat.readState.read)})})}},changeUnreadMessageCount:function(t,i,r){var f,u;t||(t="");f=n('li.media[data-friend-tenant-id="'+t+'"][data-friend-user-id="'+i+'"]');f&&(u=n(f[0]).find(".media-status span"),u.html(r),r?u.removeClass("hidden"):u.addClass("hidden"))},loadMessages:function(i,r){t.user.loadingPreviousUserMessages=!0;var f=null;i.messages&&i.messages.length&&(f=_.min(i.messages,function(n){return n.id}).id);u.getUserChatMessages({minMessageId:f,tenantId:i.friendTenantId,userId:i.friendUserId}).done(function(u){i.messages||(i.messages=[]);i.messages=u.items.concat(i.messages);t.user.markAllUnreadMessagesOfUserAsRead(i);u.items.length||(i.allPreviousMessagesLoaded=!0);var f=t.renderMessages(i.messages);n("#UserChatMessages").html(f);n(".timeago").timeago();t.user.loadingPreviousUserMessages=!1;r&&r()})},openSearchModal:function(t){var u=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers,filterText:n("#ChatUserSearchUserName").val(),extraFilters:{tenantId:t}});u.open({},function(t){var u=t.value;r.createFriendshipRequest({userId:u,tenantId:i.tenant!==null?i.tenant.id:null}).done(function(){n("#ChatUserSearchUserName").val("")})})},search:function(){var f=n("#ChatUserSearchUserName").val(),e="",u="",o;f.indexOf("\\")===-1?u=f:(o=f.split("\\"),e=o[0],u=o[1]);e&&t.interTenantChatAllowed?r.createFriendshipRequestByUserName({tenancyName:e,userName:u}).done(function(){n("#ChatUserSearchUserName").val("")}):t.user.openSearchModal(i.tenant?i.tenant.id:null,u)},setFriendOnlineStatus:function(i,r,u){var e=t.getFriendOrNull(i,r),o,f;e&&(e.isOnline=u,o="contact-status "+(u?"online":"offline"),f=n('li.media[data-friend-tenant-id="'+(r?r:"")+'"][data-friend-user-id="'+i+'"]'),f&&n(f[0]).find(".contact-status").attr("class",o),t.selectedUser&&r===t.selectedUser.friendTenantId&&i===t.selectedUser.friendUserId&&t.user.setSelectedUserOnlineStatus(u))},setSelectedUserOnlineStatus:function(i){if(t.selectedUser){var r="contact-status "+(i?"online":"offline");n("#selectedChatUserStatus").attr("class",r)}}}};t.init()})})(jQuery);